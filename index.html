<script>
  var nargs = /\{([0-9a-zA-Z_]+)\}/g;

  function rightTemplate(string) {
    var args

    if (arguments.length === 2 && typeof arguments[1] === "object") {
      args = arguments[1]
    } else {
      args = new Array(arguments.length - 1)
      for (var i = 1; i < arguments.length; ++i) {
        args[i - 1] = arguments[i]
      }
    }

    if (!args || !args.hasOwnProperty) {
      args = {}
    }

    return string.replace(nargs, function replaceArg(match, i, index) {
      var result

      if (string[index - 1] === "{" &&
        string[index + match.length] === "}") {
        return i
      } else {
        result = args.hasOwnProperty(i) ? args[i] : null
        if (result === null || result === undefined) {
          return ""
        }

        return result
      }
    })
  }

  function getPositions(string, values) {

    const postion = [];

    string.replace(nargs, function replaceArg(match, capture, index) {

      if (
        !(
          string[index - 1] === "{" &&
          string[index + match.length] === "}"
        )
      ) {
        postion.push({
          startIndex: index,
          endIndex: index + match.length,
          match: match,
          capture: capture,
          value: values[capture]
        })
      }
    });
    return postion
  }

  function parseEscape (str){
    return str.replace(nargs, function replaceArg(match, capture, index) {

      if (
        str[index - 1] === "{" &&
        str[index + match.length] === "}"
      ) {
        return capture
      }
      return match
    });
  }

  function template ({
     str,
     values,
     renderNoMatch = ()=> "",
     render
  }){
    const arr = [];
    const positions = getPositions(str, values);

    if(positions.length < 1){
      arr.push({ type: 'general', value: str });
    }else {
      let lastIndex = 0;

      positions.forEach((p)=>{
        const { startIndex, endIndex, value } = p;
        const general = str.substring(lastIndex, startIndex);
        arr.push({ type: 'general', value: general });

        if(value){
          arr.push({ type: 'var', value: value });
        }else {
          arr.push({ type: 'var', value: renderNoMatch(str, p), isNoMatch: true });
        }

        lastIndex = endIndex;
      });

      arr.push({ type:'general', value: str.substring(lastIndex) });

    }

    const parsedArr = arr.map((node)=>{
      const { type, value } = node;
      if(type === 'general' && typeof value === 'string'){
        return parseEscape(value);
      }
      return value
    });

    return render(parsedArr);
  }

  console.log(
    rightTemplate("Hello {{name}, you have {count} {vvv} {{aaa}} unread messages", {
      name: "Robert",
      count: 12
    })
  )

  template(
    {
      str: "Hello {{name}, you have {count} {vvv} {{aaa}} unread messages",
      values: {
        name: "Robert",
        count: 12
      },
      render: (arr)=>console.log(arr.join('')),
    },
  )

  ///////////////////////////////////////

  console.log(
    rightTemplate("111{name}1111", {
      name: "Robert",
      count: 12
    })
  )

  template(
    {
      str: "111{name}1111",
      values: {
        name: "Robert",
        count: 12
      },
      render: (arr)=>console.log(arr.join('')),
    },
  )


  ///////////////////////////////////

  console.log(
    rightTemplate("1111111", {
      name: "Robert",
      count: 12
    })
  )

  template(
    {
      str: "1111111",
      values: {
        name: "Robert",
        count: 12
      },
      render: (arr)=>console.log(arr.join('')),
    },
  )


  /////////////////////////////////// no match


  template(
    {
      str: "111{ggg}1111",
      renderNoMatch: ()=>'AAAA',
      values: {
        name: "Robert",
        count: 12
      },
      render: (arr)=>console.log(arr.join('')),
    },
  );

  template(
    {
      str: "111{ggg}1111",
      renderNoMatch: ()=>'{}{}{}}{}{{{}}}{AAA}',
      values: {
        name: "Robert",
        count: 12
      },
      render: (arr)=>console.log(arr.join('')),
    },
  )


  ///////////////////////////////////


  template(
    {
      str: "111{name}11{count}11{bad}ddddddd{sym}",
      renderNoMatch: ()=>'{}{}{}}{}{{{}}}{AAA}',
      values: {
        name: alert,
        count: { type: 1},
        bad: undefined,
        sym: Symbol("A"),
      },
      render: (arr)=>console.log(arr),
    },
  )






</script>
